<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forgot Password with OTP Verification</title>
  <link rel="stylesheet" href="forgot-password.css" />
  <link rel="stylesheet" href="nav.css" />
</head>
<body>
  <!-- Header Navigation -->
  <header class="header-nav">
    <div class="nav-container">
      <div class="logo">
        <h1>Princess Angel Salon</h1>
      </div>
      <nav class="main-nav">
        <a href="index.html#about">About Us</a>
        <a href="index.html#services">Services</a>
        <a href="index.html#stylists">Stylists</a>
        <a href="LoginRegister.html">Login/Register</a>
      </nav>
    </div>
  </header>

  <!-- Forgot Password Form -->
  <div class="forgotPasswordContent">
    <div class="forgot-container">
      <h2>Forgot Password</h2>
      <form id="forgotForm">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" required placeholder="Enter your email" />
        </div>
        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" required placeholder="Enter new password" />
        </div>
        <button type="submit" class="reset-btn">Reset Password</button>
      </form>
    </div>
  </div>

  <!-- OTP Modal -->
  <div class="modal" id="otpModal">
    <div class="modal-content">
      <h3>Enter 4-digit OTP</h3>
      <p class="otp-info">We sent an OTP to your email.</p>
      <div class="otp-inputs">
        <input type="text" maxlength="1" />
        <input type="text" maxlength="1" />
        <input type="text" maxlength="1" />
        <input type="text" maxlength="1" />
      </div>
      <button class="verify-btn" id="verifyBtn">Verify OTP</button>
      <button class="resend-btn" id="resendOtp" disabled>Resend OTP (30s)</button>
      <button class="close-btn" id="closeModal">Cancel</button>
    </div>
  </div>

  <!-- Notification Modal -->
  <div class="notification-modal" id="notificationModal">
    <div class="notification-content">
      <p id="notificationMessage"></p>
      <button id="notificationClose">OK</button>
    </div>
  </div>

  <script>
    const form = document.getElementById("forgotForm");
    const otpModal = document.getElementById("otpModal");
    const closeModal = document.getElementById("closeModal");
    const otpInputs = document.querySelectorAll(".otp-inputs input");
    const resendBtn = document.getElementById("resendOtp");
    const verifyBtn = document.getElementById("verifyBtn");

    const notificationModal = document.getElementById("notificationModal");
    const notificationMessage = document.getElementById("notificationMessage");
    const notificationClose = document.getElementById("notificationClose");

    let countdown;

    // 🔔 Function to show notification modal
    function showNotification(message, redirect = false) {
      notificationMessage.textContent = message;
      notificationModal.classList.add("active");

      notificationClose.onclick = () => {
        notificationModal.classList.remove("active");
        if (redirect) window.location.href = "LoginRegister.html";
      };
    }

    // 🟢 Forgot password form submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value.trim();
      const newPassword = document.getElementById("newPassword").value.trim();

      if (!email || !newPassword) {
        showNotification("Please enter both email and new password.");
        return;
      }

      try {
        const response = await fetch("/api/forgot-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        const data = await response.json();

        if (data.success) {
          otpModal.classList.add("active");
          startResendCountdown();
        } else {
          showNotification(data.message || "Failed to send OTP.");
        }
      } catch (error) {
        console.error(error);
        showNotification("Error sending OTP.");
      }
    });

    // Close OTP modal
    closeModal.addEventListener("click", () => {
      otpModal.classList.remove("active");
    });

    // Auto move to next OTP input
    otpInputs.forEach((input, index) => {
      input.addEventListener("input", () => {
        if (input.value.length === 1 && index < otpInputs.length - 1) {
          otpInputs[index + 1].focus();
        }
      });
    });

    // 🔐 Verify OTP
    verifyBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const newPassword = document.getElementById("newPassword").value.trim();
      const otp = Array.from(otpInputs).map(i => i.value).join("");

      if (otp.length !== 4) {
        showNotification("Please enter all 4 digits of the OTP.");
        return;
      }

      try {
        // 1️⃣ Verify OTP
        const verifyRes = await fetch("/api/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, otp }),
        });
        const verifyData = await verifyRes.json();

        if (!verifyData.success) {
          showNotification(verifyData.message || "Invalid OTP.");
          return;
        }

        // 2️⃣ OTP valid → Update password
        const updateRes = await fetch("/api/update-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, newPassword }),
        });
        const updateData = await updateRes.json();

        if (updateData.success) {
          otpModal.classList.remove("active");
          form.reset();
          otpInputs.forEach(i => (i.value = ""));
          showNotification("Password reset successfully!", true);
        } else {
          showNotification(updateData.message || "Failed to reset password.");
        }
      } catch (err) {
        console.error(err);
        showNotification("Error verifying OTP.");
      }
    });

    // ⏱️ Resend OTP countdown
    function startResendCountdown() {
      let timeLeft = 30;
      resendBtn.disabled = true;
      resendBtn.textContent = `Resend OTP (${timeLeft}s)`;

      countdown = setInterval(() => {
        timeLeft--;
        resendBtn.textContent = `Resend OTP (${timeLeft}s)`;
        if (timeLeft <= 0) {
          clearInterval(countdown);
          resendBtn.disabled = false;
          resendBtn.textContent = "Resend OTP";
        }
      }, 1000);
    }

    // 🔁 Resend OTP
    resendBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      if (!email) {
        showNotification("Enter your email first.");
        return;
      }

      try {
        const response = await fetch("/api/resend-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        const data = await response.json();

        if (data.success) {
          showNotification("A new OTP has been sent to your email!");
          startResendCountdown();
        } else {
          showNotification(data.message || "Failed to resend OTP.");
        }
      } catch (error) {
        console.error(error);
        showNotification("Error resending OTP.");
      }
    });
  </script>
</body>
</html>
